type: collection.insomnia.rest/5.0
name: Main
meta:
  id: wrk_e85e575ef83d4eb3b2f07d538efeef8a
  created: 1755294938718
  modified: 1757418637533
  description: ""
collection:
  - name: with Authentication
    meta:
      id: fld_75a8735663df4c6c9164cc49996a1a21
      created: 1760017656052
      modified: 1760212003785
      sortKey: -1760017656052
      description: ""
    children:
      - name: Custodian
        meta:
          id: fld_37fba565854c4ed3a3d9c395d066229a
          created: 1756737042672
          modified: 1760212003785
          sortKey: -1760017663221
          description: ""
        children:
          - url: "{{ _.url }}/custodian"
            name: /custodian (List)
            meta:
              id: req_5ebc8c52f4c14235a0337ab687be860e
              created: 1756737047710
              modified: 1756737204173
              isPrivate: false
              description: ""
              sortKey: -1756737047710
            method: GET
            headers:
              - name: User-Agent
                value: insomnia/11.5.0
            settings:
              renderRequestBody: true
              encodeUrl: true
              followRedirects: global
              cookies:
                send: true
                store: true
              rebuildPath: true
          - url: "{{ _.url }}/custodian"
            name: /custodian (Create)
            meta:
              id: req_c374f205da2c4ab6a2f09ae3afb7192e
              created: 1756764131003
              modified: 1760097933779
              isPrivate: false
              description: ""
              sortKey: -1756737047810
            method: POST
            body:
              mimeType: application/json
              text: |-
                {
                	"name": "Fineco",
                	"kind": "Bank",
                	"description": "Italian bank account",
                	"url": "https://fineco.it",
                	"wallet_address": null,
                	"account_country_code": "IT"
                }
            headers:
              - name: Content-Type
                value: application/json
              - name: User-Agent
                value: insomnia/11.5.0
            settings:
              renderRequestBody: true
              encodeUrl: true
              followRedirects: global
              cookies:
                send: true
                store: true
              rebuildPath: true
          - url: "{{ _.url }}/custodian"
            name: /custodian (Update)
            meta:
              id: req_fc1e1d4bde324c81ac2701bc56c41f93
              created: 1757323917993
              modified: 1757324460216
              isPrivate: false
              description: ""
              sortKey: -1756737047760
            method: PUT
            body:
              mimeType: application/json
              text: |-
                {
                	"id": 3,
                	"name": "Nexo",
                	"kind": "Fintech Platform",
                	"description": "Cryptodurrency platform",
                	"url": "https://nexo.com",
                	"wallet_address": null,
                	"country_code": "IT"
                }
            headers:
              - name: Content-Type
                value: application/json
              - name: User-Agent
                value: insomnia/11.5.0
            settings:
              renderRequestBody: true
              encodeUrl: true
              followRedirects: global
              cookies:
                send: true
                store: true
              rebuildPath: true
      - name: Currency
        meta:
          id: fld_7e7d4578e0154c9188ce203dc89f2166
          created: 1756737093987
          modified: 1760125523616
          sortKey: -1760017663321
          description: ""
        children:
          - url: "{{ _.url }}/currency/123"
            name: /currency/{id} (Single)
            meta:
              id: req_a0d8ffc90345461a916aa1bbe24c0d4e
              created: 1755295289332
              modified: 1756737175716
              isPrivate: false
              description: ""
              sortKey: -1756737103977
            method: GET
            headers:
              - name: User-Agent
                value: insomnia/11.4.0
            settings:
              renderRequestBody: true
              encodeUrl: true
              followRedirects: global
              cookies:
                send: true
                store: true
              rebuildPath: true
          - url: "{{ _.url }}/currency"
            name: /currency (List)
            meta:
              id: req_3bb621e55a354831a0d7750084e3e4a9
              created: 1755296835097
              modified: 1756737181404
              isPrivate: false
              description: ""
              sortKey: -1756737103877
            method: GET
            headers:
              - name: User-Agent
                value: insomnia/11.4.0
            settings:
              renderRequestBody: true
              encodeUrl: true
              followRedirects: global
              cookies:
                send: true
                store: true
              rebuildPath: true
          - url: "{{ _.url }}/currency"
            name: /currency (Create)
            meta:
              id: req_fb0aa59debd148bcad48bbcaf489b9aa
              created: 1755296976015
              modified: 1756737170889
              isPrivate: false
              description: ""
              sortKey: -1756737104077
            method: POST
            body:
              mimeType: application/json
              text: |-
                {
                	"symbol": "GBP",
                	"name": "Pound",
                	"kind": "Fiat",
                	"is_active": true,
                	"precision": 2
                }
            headers:
              - name: Content-Type
                value: application/json
              - name: User-Agent
                value: insomnia/11.4.0
            settings:
              renderRequestBody: true
              encodeUrl: true
              followRedirects: global
              cookies:
                send: true
                store: true
              rebuildPath: true
          - url: "{{ _.url }}/currency"
            name: /currency (Update)
            meta:
              id: req_e4df2afafa304ebf85b5979f2f81350a
              created: 1756732326032
              modified: 1756737187608
              isPrivate: false
              description: ""
              sortKey: -1756737103777
            method: PUT
            body:
              mimeType: application/json
              text: |-
                {
                	"id": 1,
                	"symbol": "XRD",
                	"name": "Radix",
                	"kind": "Crypto",
                	"is_active": true,
                	"precision": 18
                }
            headers:
              - name: Content-Type
                value: application/json
              - name: User-Agent
                value: insomnia/11.4.0
            settings:
              renderRequestBody: true
              encodeUrl: true
              followRedirects: global
              cookies:
                send: true
                store: true
              rebuildPath: true
      - name: Holding
        meta:
          id: fld_c672938919c4403b8211ce1ad419300b
          created: 1760091275513
          modified: 1760181323687
          sortKey: -1760091275513
          description: ""
        children:
          - url: "{{ _.url }}/holding"
            name: /holding (Create)
            meta:
              id: req_395fda27612046d093fd8047e3522ebf
              created: 1760091285419
              modified: 1760131509960
              isPrivate: false
              description: ""
              sortKey: -1760091285419
            method: POST
            body:
              mimeType: application/json
              text: |-
                {
                	"custodianId": 1,
                	"currencyId": 1,
                	"date": "2025-09-02T10:30:00Z",
                	"action": "Balance At",
                	"amount": "100",
                	"note": "Verified on website"
                }
            headers:
              - name: Content-Type
                value: application/json
                id: pair_57fa628187e54857afa92269b1e69bd2
              - name: User-Agent
                value: insomnia/11.6.1
                id: pair_754464f5340945f5b15ac1a409d7d113
              - id: pair_58227a66b2694bd088b08ba5b3382151
                name: X-Auth-Token
                value: "{{ _.accessToken }}"
                description: ""
                disabled: true
            settings:
              renderRequestBody: true
              encodeUrl: true
              followRedirects: global
              cookies:
                send: true
                store: true
              rebuildPath: true
          - url: "{{ _.url }}/holding"
            name: /holding (List)
            meta:
              id: req_746df01997714aa4864bcad83361d3a3
              created: 1760124782528
              modified: 1760124829105
              isPrivate: false
              description: ""
              sortKey: -1760124782528
            method: GET
            headers:
              - name: User-Agent
                value: insomnia/11.6.1
            settings:
              renderRequestBody: true
              encodeUrl: true
              followRedirects: global
              cookies:
                send: true
                store: true
              rebuildPath: true
        headers:
          - id: pair_c23bbdd1a88c40939b4e1e7414422dae
            name: ""
            value: ""
            description: ""
            disabled: false
    scripts:
      preRequest: "// Update the access_token in the Bae Environment (Collection
        environment)

        //const moment = require(\"moment\")


        const logInfo = text => console.info(\">>>>> \" + text)

        const logWarn = text => console.warn(\">>>>> \" + text)

        const logError = text => console.error(\">>>>> \" + text)


        const accessToken = insomnia.baseEnvironment.get(\"accessToken\")

        const refreshToken = insomnia.baseEnvironment.get(\"refreshToken\")

        const accessTokenExpiresAtString =
        insomnia.baseEnvironment.get(\"accessTokenExpiresAt\") // can be
        undefined

        const refreshTokenExpiresAtString =
        insomnia.baseEnvironment.get(\"refreshTokenExpiresAt\") // can be
        undefined


        //logInfo(`accessTokenExpiresAtString: ${accessTokenExpiresAtString}`)

        //logInfo(`new Date(accessTokenExpiresAtString): ${new
        Date(accessTokenExpiresAtString)}`)

        //logInfo(`Date.now()): ${Date.now()}`)


        //if (moment(authTokenExpiresAt) < moment()) {

        if (!accessTokenExpiresAtString || new Date(accessTokenExpiresAtString)
        < Date.now()) {

        \tlogInfo(`Access Token is expired ${accessTokenExpiresAtString}.`)

        \t

        \tif (new Date(refreshTokenExpiresAtString) < Date.now()) {

        \t\tlogInfo(`Refresh Token is expired ${refreshTokenExpiresAtString}.`)

        \t\tlogWarn(\"Access and refresh tokens both expired. You need to login
        again !\")

        \t\treturn;

        \t}\t


        \t// *** here (folder script) there is no access to the (selected)
        sub-environment, but only to the Base Environment

        \  // insomnia.environment.get(\"url\")\tis undefined

        \t// insomnia.request.url.urlObject  is undefined

        \t

        \t// try use the internal insomnia.variables.globalVars

        \tif(!insomnia.variables.globalVars.has(\"url\"))\ 

        \t\tthrow new Error(\"Variable 'url' not found in folder script\")\ 

        \t\t

        \tconst apiUrl = insomnia.variables.globalVars.get(\"url\")\t// override
        a local variable with a ctual value from sub-level environment

        \  const url = apiUrl + \"/auth/refresh\"

        \tlogInfo(`Call refresh token endpoint: ${url}`)

        \t

        \tconst response = await insomnia.sendRequest(

        \t{

        \t\t\turl: url,

        \t\t\tmethod: \"POST\",

        \t\t\theader: { \"Content-Type\": \"application/json\"},

        \t\t\tbody: {

        \t\t\t\tmode: \"raw\",

        \t\t\t\traw: JSON.stringify( { refreshToken: refreshToken })

        \t\t\t}

        \t})

        \t

        \tif (response.status !== 200)\ 

        \t\t throw new Error(`Refresh token call failed with status
        ${response.status}. ${response.body}`);

        \t\t


        \tconst jsonBody = response.json();

        \tconst new_accessToken = jsonBody.accessToken

        \tconst new_refreshToken = jsonBody.refreshToken

        \tconst new_accessTokenExpiresAtString = jsonBody.accessTokenExpiresAt

        \tconst new_refreshTokenExpiresAtString = jsonBody.refreshTokenExpiresAt

        \t

        \tif (new_accessToken && new_refreshToken &&
        new_accessTokenExpiresAtString && new_refreshTokenExpiresAtString) {

        \t\tlogInfo(`Set Base Environment Access and Refresh tokens with new
        values: ${new_accessToken} and ${new_refreshToken}`)

        \t\tinsomnia.baseEnvironment.set(\"accessToken\",
        new_accessToken)\t\t\t\t\t\t

        \t\tinsomnia.baseEnvironment.set(\"refreshToken\",
        new_refreshToken)\t\t\t\t\t\t

        \t\tinsomnia.baseEnvironment.set(\"accessTokenExpiresAt\",
        new_accessTokenExpiresAtString)

        \t\tinsomnia.baseEnvironment.set(\"refreshTokenExpiresAt\",
        new_refreshTokenExpiresAtString)

        \t}\telse {

        \t\tlogError(\"Some property is undefined or not found in the JSON
        response\")

        \t\tlogInfo(`Response content: ${response.body}`)

        \t}\t

        }

        else {

        \tlogInfo(\"The access token is NOT expired. OK.\")

        }

        \t"
    authentication:
      type: none
    environment:
      __url: "{{ _.url }}"
      aaa: test
    environmentPropertyOrder:
      "&":
        - __url
        - aaa
    headers:
      - id: pair_f4cc659ca68c42459817afdc9b2f55a1
        name: X-Auth-Token
        value: "{{ _.accessToken }}"
        description: ""
        disabled: false
  - name: anonymous calls
    meta:
      id: fld_2e9b0fe89d7a49db8fcf58030fd8ae95
      created: 1760017700058
      modified: 1760219962531
      sortKey: -1760017700058
      description: ""
    children:
      - url: "{{ _.url }}/"
        name: home
        meta:
          id: req_b9f230d9923f414d9baac3bc51de0215
          created: 1755294938898
          modified: 1760017719895
          isPrivate: false
          description: ""
          sortKey: -1760017712490
        method: GET
        parameters:
          - id: pair_06e0ce4df1174e14bd530feaa29e91ab
            name: ""
            value: ""
            description: ""
            disabled: false
        headers:
          - name: User-Agent
            value: insomnia/11.4.0
        settings:
          renderRequestBody: true
          encodeUrl: true
          followRedirects: global
          cookies:
            send: true
            store: true
          rebuildPath: true
      - name: Auth
        meta:
          id: fld_84fc3822e5ef45c19bb481187a6460c6
          created: 1759332730257
          modified: 1760219962531
          sortKey: -1760017712390
          description: ""
        children:
          - url: "{{ _.url }}/auth/login"
            name: /login
            meta:
              id: req_f299cc90d90943e482c866079202d60a
              created: 1759332736647
              modified: 1760257978021
              isPrivate: false
              description: ""
              sortKey: -1759332736647
            method: POST
            body:
              mimeType: application/json
              text: |-
                {
                	"username": "demo-1",
                	"password": "demo-1"
                }
            headers:
              - name: Content-Type
                value: application/json
              - name: User-Agent
                value: insomnia/11.6.1
            scripts:
              afterResponse: >
                // Set the base Environment variables for authentication

                const moment = require("moment")


                const logInfo = text => console.info(">>>>> LOG " + text)

                const logWarn = text => console.warn(">>>>> LOG " + text)

                const logError = text => console.error(">>>>> LOG " + text)


                // get the token

                if (insomnia.response.code == 200) {
                	const jsonBody = insomnia.response.json();
                  const accessToken = jsonBody.accessToken
                	const refreshToken = jsonBody.refreshToken
                	const accessTokenExpiresAtString = jsonBody.accessTokenExpiresAt
                	const refreshTokenExpiresAtString = jsonBody.refreshTokenExpiresAt
                	const expiresAt = moment(accessTokenExpiresAtString)
                	
                	if (accessToken && refreshToken && accessTokenExpiresAtString && refreshTokenExpiresAtString) {
                		logInfo(`Set Base Environment variables with new token: ${accessToken} and ${refreshToken}`)
                		insomnia.baseEnvironment.set("accessToken", accessToken)		
                		insomnia.baseEnvironment.set("refreshToken", refreshToken)
                		insomnia.baseEnvironment.set("accessTokenExpiresAt", accessTokenExpiresAtString)
                		insomnia.baseEnvironment.set("refreshTokenExpiresAt", refreshTokenExpiresAtString)
                	}	else {
                		logError("some properties are undefined in the JSON response")
                		logInfo(`response: ${insomnia.response}`)
                	}
                }
            settings:
              renderRequestBody: true
              encodeUrl: true
              followRedirects: global
              cookies:
                send: true
                store: true
              rebuildPath: true
          - url: "{{ _.url }}/auth/signup"
            name: /signup
            meta:
              id: req_081f51b09d684716a5a6739f8ea888fb
              created: 1759415965915
              modified: 1760257958886
              isPrivate: false
              description: ""
              sortKey: -1758376094211
            method: POST
            body:
              mimeType: application/json
              text: |-
                {
                	"username": "demo-1",
                	"password": "demo-1",
                	"currencyId": 1
                }
            headers:
              - name: Content-Type
                value: application/json
              - name: User-Agent
                value: insomnia/11.6.1
            settings:
              renderRequestBody: true
              encodeUrl: true
              followRedirects: global
              cookies:
                send: true
                store: true
              rebuildPath: true
          - url: "{{ _.url }}/auth/refresh"
            name: /refresh
            meta:
              id: req_adc14fc9dfe743ef8c60e892cea6fd8a
              created: 1760180563533
              modified: 1760257982295
              isPrivate: false
              description: ""
              sortKey: -1760180563533
            method: POST
            body:
              mimeType: application/json
              text: |-
                {
                	"refreshToken": "{{ _.refreshToken }}"
                }
            headers:
              - name: Content-Type
                value: application/json
              - name: User-Agent
                value: insomnia/11.6.1
            settings:
              renderRequestBody: true
              encodeUrl: true
              followRedirects: global
              cookies:
                send: true
                store: true
              rebuildPath: true
cookieJar:
  name: Default Jar
  meta:
    id: jar_f322ba964e83a6cb0018749707cbaf634cb9e10a
    created: 1755294938724
    modified: 1760219962524
environments:
  name: Base Environment
  meta:
    id: env_f322ba964e83a6cb0018749707cbaf634cb9e10a
    created: 1755294938721
    modified: 1760219962527
    isPrivate: false
  data:
    accessToken: zOC-1nNj18eRN1GIKcDrh1mDwfqtKGBrpk84FvuW8hgx8t4Epf7u1JIYhu_3I2xx
    refreshToken: StuVMxkllJx7DUXy167mvLvPPs7gDDPB3wNbF3mijQ2rPrmwOvlmfYs5a6kbK98r
    accessTokenExpiresAt: 2025-10-11T22:29:22.448383291Z
    refreshTokenExpiresAt: 2025-11-10T21:59:22.448383291Z
